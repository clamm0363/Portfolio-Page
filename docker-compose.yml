version: '3.8'

services:
  nginx:
    image: nginx:alpine
    networks:
      - public
    ports:
      - target: 80
        published: 8001
        mode: ingress
    volumes:
      - /mnt/cephfs/portfolio/html/index.html:/usr/share/nginx/html/index.html:ro
      - /mnt/cephfs/portfolio/html/assets:/usr/share/nginx/html/assets:ro
      - /mnt/cephfs/portfolio/html/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - umami
    deploy:
      replicas: 1

  umami-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-umami}
      POSTGRES_USER: ${POSTGRES_USER:-umami}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-umami}
    networks:
      - public
    volumes:
      - /mnt/cephfs/portfolio/db:/var/lib/postgresql/data
    deploy:
      replicas: 1
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-umami}"]
      interval: 10s
      timeout: 5s
      retries: 5

  umami:
    image: ghcr.io/umami-software/umami:postgresql-latest
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-umami}:${POSTGRES_PASSWORD:-umami}@umami-db:5432/${POSTGRES_DB:-umami}
      DATABASE_TYPE: postgresql
      HASH_SALT: ${UMAMI_HASH_SALT:-change-me-to-random-string}
      APP_ENV: production
    ports:
      - target: 3000
        published: 3002
        mode: ingress
    depends_on:
      - umami-db
    networks:
      - public
    deploy:
      replicas: 1

  cloudflared:
    image: cloudflare/cloudflared:latest
    networks:
      - public
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN}
    command: tunnel run
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

networks:
  public:
    external: true
